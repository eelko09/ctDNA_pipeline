# ============================================================
# ctDNA / cfDNA Snakemake Pipeline Configuration (Test)
# ============================================================

samples_tsv: "workflow/samples.tsv"

# Toggle for quick testing (redirects paths to tests/)
testing: false

# ============================================================
# Variant-calling strategy (v2 scaffold)
# ============================================================
variant_calling:
  # Options:
  # - tumor_only: call each sample independently (current default behavior)
  # - tumor_normal: call tumor samples with matched normal if normal_sample is set
  # - auto: use tumor-normal when normal_sample exists, else tumor-only
  mode: "auto"

  mutect2:
    # Forwarded to Mutect2 and FilterMutectCalls --min-allele-fraction
    min_allele_fraction: 0.001

  postfilter:
    # Additional ctDNA-oriented hard filters after FilterMutectCalls.
    pass_only: true
    min_dp: 100
    min_alt_reads: 3
    min_af: 0.005

# ============================================================
# QC Gates (v2 scaffold)
# ============================================================
qc_gates:
  min_mapped_pct: 95.0
  min_mean_coverage: 200.0
  max_dup_fraction: 0.90
  max_contamination: 0.02

# ============================================================
# Clinical support gates (Phase 6)
# ============================================================
clinical_support_gates:
  min_dp: 100
  min_alt_reads: 3
  min_af: 0.005
  low_vaf_threshold: 0.01
  require_orthogonal_low_vaf: true
  chip_flag_action: "review"

# ============================================================
# LOD model bins (Phase 6)
# ============================================================
lod:
  bins:
    - name: "0.1%-0.5%"
      min_af: 0.001
      max_af: 0.005
    - name: "0.5%-1.0%"
      min_af: 0.005
      max_af: 0.01
    - name: "1.0%-5.0%"
      min_af: 0.01
      max_af: 0.05

# ============================================================
# Assay-specific enhancements (Phase 5 scaffold)
# ============================================================
assay:
  umi:
    enabled: false
    method: "umi_tools"
    # For umi_tools extract (paired-end), example: NNNNNNNN
    bc_pattern: "NNNNNNNN"

  orthogonal:
    enabled: false
    # Directory with one TSV per sample: <sample>.tsv
    # Required columns: CHROM, POS, REF, ALT
    calls_dir: "workflow/resources/orthogonal_calls"

  chip:
    enabled: false
    # TSV with CHIP hotspots.
    # Required columns: CHROM, POS, REF, ALT, GENE
    panel_tsv: "workflow/resources/chip_hotspots.tsv"

  wbc_filter:
    enabled: false
    # Directory with one TSV per matched normal sample: <normal_sample>.tsv
    # Required columns: CHROM, POS, REF, ALT
    calls_dir: "workflow/resources/wbc_calls"
    fail_on_support: true

clinical_annotations:
  enabled: false
  # TSV with columns: CHROM, POS, REF, ALT, GENE, CLINICAL_TIER, ACTIONABILITY
  panel_tsv: "workflow/resources/clinical_annotations.tsv"

clinical_output:
  enabled: true
  # Keep rows with support_gate in this list.
  accepted_support_gates: ["PASS", "REVIEW"]
  # If true, keep only clinically annotated rows.
  include_only_annotated: false

# ============================================================
# Pair integrity and repair
# ============================================================
pair_repair:
  enabled: true
  # Fail sample if singleton reads exceed this fraction of repaired pairs.
  max_singleton_fraction: 0.02

# ============================================================
# References
# ============================================================

references:
  # Primary reference (GRCh38 + decoy)
  reference_fasta: "ref/grch38/Homo_sapiens_assembly38.fasta"

  # Panel / capture intervals (TruSight Cancer)
  panel_bed: "ref/grch38/TruSight_Cancer_TargetedRegions_v1.0.hg38.bed"

  # Known sites (BQSR)
  known_sites:
    dbsnp: "ref/grch38/Homo_sapiens_assembly38.dbsnp138.vcf.gz"
    mills_indels: "ref/grch38/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz"

  # Mutect2 germline resource
  germline_resource: "ref/grch38/af-only-gnomad.hg38.vcf.gz"

  # Common variants resource
  common_variants: "ref/grch38/small_exac_common_3.hg38.vcf.gz"

  # Panel of Normals (PoN)
  pon_vcf: "ref/grch38/1000g_pon.hg38.vcf.gz"

  # Optional: blacklist regions
  blacklist_bed: "ref/grch38/hg38-blacklist.v2.bed"

# HsMetrics test BEDs
hs_metrics_baits: "ref/grch38/test_baits.bed"
hs_metrics_targets: "ref/grch38/test_targets.bed"

# ============================================================
# Resources (threads + memory per rule) - optimized for testing
# ============================================================

resources:
  # --------------------------
  # QC
  # --------------------------
  fastqc:
    threads: 1
    mem_mb: 2000

  multiqc:
    threads: 1
    mem_mb: 2000

  # --------------------------
  # Trimming
  # --------------------------
  fastp:
    threads: 2
    mem_mb: 4000

  # --------------------------
  # Reference / Indexing
  # --------------------------
  bwa_index:
    threads: 4
    mem_mb: 16000

  # --------------------------
  # Alignment + BAM processing
  # --------------------------
  bwa_mem:
    threads: 2
    mem_mb: 4000

  samtools_sort:
    threads: 2
    mem_mb: 4000

  # --------------------------
  # Duplicate marking
  # --------------------------
  markdup:
    threads: 1
    mem_mb: 4000

  # --------------------------
  # GATK + Variant Calling
  # --------------------------
  gatk:
    threads: 1
    mem_mb: 8000
    Xmx: "8"

  mutect2:
    threads: 1
    mem_mb: 8000
    Xmx: "8"

  filter_mutect:
    threads: 1
    mem_mb: 8000
    Xmx: "8"

  # --------------------------
  # Optional tools
  # --------------------------
  vep:
    threads: 1
    mem_mb: 4000

  ichorcna:
    threads: 1
    mem_mb: 4000

  msisensor2:
    threads: 1
    mem_mb: 2000
